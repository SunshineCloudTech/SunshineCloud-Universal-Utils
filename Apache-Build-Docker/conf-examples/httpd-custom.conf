# Apache HTTP Server 自定义配置示例
# 将此文件复制到 /usr/local/apache2/conf/extra/ 目录下
# 并在主配置文件中添加 Include conf/extra/httpd-custom.conf

# ================================
# 虚拟主机配置示例
# ================================

# 默认虚拟主机
<VirtualHost *:80>
    ServerName localhost
    ServerAlias www.localhost
    DocumentRoot /usr/local/apache2/htdocs
    
    # 日志配置
    ErrorLog /var/log/apache2/localhost_error.log
    CustomLog /var/log/apache2/localhost_access.log combined
    
    # 安全配置
    <Directory "/usr/local/apache2/htdocs">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 防止访问敏感文件
        <FilesMatch "^\.">
            Require all denied
        </FilesMatch>
        
        # 禁止执行 PHP 文件（如果不需要）
        <FilesMatch "\.php$">
            Require all denied
        </FilesMatch>
    </Directory>
</VirtualHost>

# HTTPS 虚拟主机示例
<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerName localhost
        ServerAlias www.localhost
        DocumentRoot /usr/local/apache2/htdocs
        
        # SSL 配置
        SSLEngine on
        SSLCertificateFile /etc/ssl/apache/server.crt
        SSLCertificateKeyFile /etc/ssl/apache/server.key
        # SSLCertificateChainFile /etc/ssl/apache/chain.crt
        
        # 现代 SSL 配置
        SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
        SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
        SSLHonorCipherOrder off
        
        # 安全头
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        
        # 日志配置
        ErrorLog /var/log/apache2/localhost_ssl_error.log
        CustomLog /var/log/apache2/localhost_ssl_access.log combined
        
        <Directory "/usr/local/apache2/htdocs">
            Options -Indexes +FollowSymLinks
            AllowOverride All
            Require all granted
        </Directory>
    </VirtualHost>
</IfModule>

# ================================
# 多站点配置示例
# ================================

# 站点 1
<VirtualHost *:80>
    ServerName site1.example.com
    DocumentRoot /usr/local/apache2/htdocs/site1
    
    ErrorLog /var/log/apache2/site1_error.log
    CustomLog /var/log/apache2/site1_access.log combined
    
    <Directory "/usr/local/apache2/htdocs/site1">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

# 站点 2
<VirtualHost *:80>
    ServerName site2.example.com
    DocumentRoot /usr/local/apache2/htdocs/site2
    
    ErrorLog /var/log/apache2/site2_error.log
    CustomLog /var/log/apache2/site2_access.log combined
    
    <Directory "/usr/local/apache2/htdocs/site2">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

# ================================
# 反向代理配置示例
# ================================

<IfModule mod_proxy.c>
    # 代理到后端应用
    <VirtualHost *:80>
        ServerName api.example.com
        
        # 代理配置
        ProxyPreserveHost On
        ProxyPass / http://backend-server:8080/
        ProxyPassReverse / http://backend-server:8080/
        
        # 负载均衡示例
        # ProxyPass / balancer://mycluster/
        # ProxyPassReverse / balancer://mycluster/
        # 
        # <Proxy balancer://mycluster>
        #     BalancerMember http://backend1:8080
        #     BalancerMember http://backend2:8080
        #     ProxySet lbmethod=byrequests
        # </Proxy>
        
        ErrorLog /var/log/apache2/api_error.log
        CustomLog /var/log/apache2/api_access.log combined
    </VirtualHost>
</IfModule>

# ================================
# 静态文件缓存配置
# ================================

<IfModule mod_expires.c>
    # 启用过期头
    ExpiresActive On
    
    # 图片文件 - 1 个月
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    
    # CSS 和 JavaScript - 1 周
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType application/x-javascript "access plus 1 week"
    
    # 字体文件 - 1 个月
    ExpiresByType font/ttf "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
    ExpiresByType application/font-woff "access plus 1 month"
    
    # HTML 文件 - 1 小时
    ExpiresByType text/html "access plus 1 hour"
    
    # JSON 和 XML - 1 小时
    ExpiresByType application/json "access plus 1 hour"
    ExpiresByType application/xml "access plus 1 hour"
    ExpiresByType text/xml "access plus 1 hour"
</IfModule>

# ================================
# 压缩配置增强
# ================================

<IfModule mod_deflate.c>
    # 启用压缩的文件类型
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/font-woff
    AddOutputFilterByType DEFLATE image/svg+xml
    
    # 排除压缩的文件
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|zip|gz|tgz|bz2|rar|7z)$ no-gzip dont-vary
    
    # 压缩级别设置
    DeflateCompressionLevel 6
    
    # 不压缩小文件
    SetEnvIfNoCase Content-Length "^[0-9]{1,3}$" no-gzip
</IfModule>

# ================================
# 安全配置增强
# ================================

<IfModule mod_headers.c>
    # 安全头配置
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # 移除服务器信息
    Header always unset Server
    Header always unset X-Powered-By
    
    # CORS 配置（根据需要调整）
    # Header always set Access-Control-Allow-Origin "*"
    # Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    # Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
</IfModule>

# ================================
# 重写规则示例
# ================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # 强制 HTTPS（如果有 SSL 证书）
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # 移除 www 前缀
    # RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    # RewriteRule ^(.*)$ http://%1/$1 [R=301,L]
    
    # 添加尾随斜杠
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_URI} !(.*)/$
    RewriteRule ^(.*)$ $1/ [L,R=301]
    
    # SPA 应用支持（所有路由指向 index.html）
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteCond %{REQUEST_FILENAME} !-d
    # RewriteRule . /index.html [L]
</IfModule>

# ================================
# 访问控制示例
# ================================

# 限制访问管理目录
<Directory "/usr/local/apache2/htdocs/admin">
    # 基于 IP 的访问控制
    <RequireAll>
        Require ip 192.168.1
        Require ip 10.0.0
        # Require valid-user  # 需要配合认证模块使用
    </RequireAll>
</Directory>

# 防止访问隐藏文件
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# 防止访问备份文件
<FilesMatch "\.(bak|backup|old|orig|save|swp|tmp)$">
    Require all denied
</FilesMatch>

# ================================
# 日志格式自定义
# ================================

# 详细日志格式
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %T" detailed
LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" proxy

# JSON 格式日志
LogFormat "{ \"time\":\"%{%Y-%m-%d %H:%M:%S}t\", \"remoteIP\":\"%h\", \"host\":\"%V\", \"request\":\"%U\", \"query\":\"%q\", \"method\":\"%m\", \"status\":\"%>s\", \"userAgent\":\"%{User-agent}i\", \"referer\":\"%{Referer}i\" }" json

# ================================
# 性能监控配置
# ================================

<IfModule mod_status.c>
    # 服务器状态页面
    <Location "/server-status">
        SetHandler server-status
        Require local
        # Require ip 192.168.1
    </Location>
    
    # 扩展状态信息
    ExtendedStatus On
</IfModule>

<IfModule mod_info.c>
    # 服务器信息页面
    <Location "/server-info">
        SetHandler server-info
        Require local
        # Require ip 192.168.1
    </Location>
</IfModule>

# ================================
# 限速配置示例
# ================================

<IfModule mod_evasive24.c>
    # 防 DDoS 配置（需要安装 mod_evasive）
    DOSHashTableSize    2048
    DOSPageCount        2
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    DOSLogDir           /var/log/apache2
    DOSSystemCommand    "iptables -A INPUT -s %s -j DROP"
</IfModule>

# ================================
# 自定义错误页面
# ================================

# 自定义错误页面
ErrorDocument 400 /errors/400.html
ErrorDocument 401 /errors/401.html
ErrorDocument 403 /errors/403.html
ErrorDocument 404 /errors/404.html
ErrorDocument 500 /errors/500.html
ErrorDocument 502 /errors/502.html
ErrorDocument 503 /errors/503.html